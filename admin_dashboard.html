<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - All Users</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #333;
            margin-bottom: 5px;
        }

        .header p {
            color: #666;
            font-size: 14px;
        }

        .back-button {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s;
        }

        .back-button:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        /* MAIN DASHBOARD VIEW */
        #mainDashboard {
            display: block;
        }

        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            color: #666;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        .stat-card .value {
            color: #333;
            font-size: 36px;
            font-weight: 700;
        }

        .users-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .user-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .user-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        .user-card-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .user-avatar {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: 700;
        }

        .user-info h3 {
            color: #333;
            font-size: 18px;
            margin-bottom: 5px;
        }

        .user-info p {
            color: #666;
            font-size: 14px;
        }

        .user-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .user-stat-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
        }

        .user-stat-label {
            color: #666;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .user-stat-value {
            color: #333;
            font-size: 20px;
            font-weight: 700;
        }

        .streak-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* USER DETAIL VIEW */
        #userDetailView {
            display: none;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .detail-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .detail-card h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
        }

        .large-stat {
            font-size: 48px;
            font-weight: 700;
            color: #333;
            margin: 20px 0;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s ease;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .stat-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
        }

        .stat-label {
            color: #666;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .stat-value {
            color: #333;
            font-size: 24px;
            font-weight: 700;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        .list-item {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge.easy { background: #e8f5e9; color: #388e3c; }
        .badge.moderate { background: #fff3e0; color: #f57c00; }
        .badge.hard { background: #ffe0e0; color: #d32f2f; }

        .loading {
            text-align: center;
            padding: 60px 20px;
            color: white;
            font-size: 18px;
        }

        .loading.active {
            display: block;
        }

        .error {
            background: #ffe0e0;
            color: #d32f2f;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .error.active {
            display: block;
        }

        .wide-card {
            grid-column: 1 / -1;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-size: 12px;
            text-transform: uppercase;
            color: #666;
            border-bottom: 2px solid #e0e0e0;
        }

        .table td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
            color: #333;
        }

        .table tr:hover {
            background: #f8f9fa;
        }

        @media (max-width: 768px) {
            .users-grid {
                grid-template-columns: 1fr;
            }
            .detail-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Loading State -->
        <div class="loading" id="loading">
            ‚è≥ Loading dashboard...
        </div>

        <!-- Error State -->
        <div class="error" id="error"></div>

        <!-- ========================================== -->
        <!-- MAIN DASHBOARD - ALL USERS -->
        <!-- ========================================== -->
        <div id="mainDashboard" style="display: none;">
            <div class="header">
                <div>
                    <h1>üìö Learning Platform - Admin Dashboard</h1>
                    <p>Overview of all users and their learning progress</p>
                </div>
                <button class="back-button" onclick="loadMainDashboard()">üîÑ Refresh</button>
            </div>

            <!-- Overall Stats -->
            <div class="stats-overview">
                <div class="stat-card">
                    <h3>Total Users</h3>
                    <div class="value" id="totalUsers">0</div>
                </div>
                <div class="stat-card">
                    <h3>Active Today</h3>
                    <div class="value" id="activeToday">0</div>
                </div>
                <div class="stat-card">
                    <h3>Total Words Learned</h3>
                    <div class="value" id="totalWords">0</div>
                </div>
                <div class="stat-card">
                    <h3>Average Success Rate</h3>
                    <div class="value" id="avgSuccess">0%</div>
                </div>
            </div>

            <!-- Users Grid -->
            <div class="users-grid" id="usersGrid"></div>
        </div>

        <!-- ========================================== -->
        <!-- USER DETAIL VIEW -->
        <!-- ========================================== -->
        <div id="userDetailView">
            <div class="header">
                <div>
                    <h1 id="userDetailName">User Details</h1>
                    <p id="userDetailInfo">Loading...</p>
                </div>
                <button class="back-button" onclick="showMainDashboard()">‚Üê Back to All Users</button>
            </div>

            <!-- User Detail Content -->
            <div class="detail-grid">
                <div class="detail-card">
                    <h3><div class="icon">üî•</div> Current Streak</h3>
                    <div class="large-stat" id="detailStreak">0</div>
                    <div class="stat-label">Days in a row</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="detailStreakProgress"></div>
                    </div>
                </div>

                <div class="detail-card">
                    <h3><div class="icon">üéØ</div> Success Rate</h3>
                    <div class="large-stat" id="detailSuccess">0%</div>
                    <div class="stat-label">Overall accuracy</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="detailSuccessProgress"></div>
                    </div>
                </div>

                <div class="detail-card">
                    <h3><div class="icon">üìä</div> Learning Stats</h3>
                    <div class="stat-grid" id="detailLearningStats"></div>
                </div>

                <div class="detail-card">
                    <h3><div class="icon">üí™</div> Word Mastery</h3>
                    <div id="detailWordMastery"></div>
                </div>
            </div>

            <!-- Challenging Words -->
            <div class="detail-card wide-card">
                <h3><div class="icon">üò∞</div> Most Challenging Words</h3>
                <div id="detailChallengingWords"></div>
            </div>

            <!-- Charts -->
            <div class="detail-grid">
                <div class="detail-card">
                    <h3><div class="icon">üìã</div> Mistakes by Type</h3>
                    <div class="chart-container">
                        <canvas id="detailMistakeChart"></canvas>
                    </div>
                </div>

                <div class="detail-card">
                    <h3><div class="icon">üìà</div> Progress Timeline</h3>
                    <div class="chart-container">
                        <canvas id="detailTimelineChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="detail-card wide-card">
                <h3><div class="icon">üìÖ</div> Recent Activity</h3>
                <table class="table" id="detailRecentActivity"></table>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const SUPABASE_URL = 'YOUR_SUPABASE_URL';
        const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let allUsersData = [];

        // ============================================
        // INITIALIZATION
        // ============================================
        window.addEventListener('DOMContentLoaded', () => {
            loadMainDashboard();
        });

        // ============================================
        // MAIN DASHBOARD FUNCTIONS
        // ============================================
        async function loadMainDashboard() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('mainDashboard').style.display = 'none';
            document.getElementById('error').classList.remove('active');

            try {
                // Get all users
                const { data: users, error: usersError } = await supabase
                    .from('users')
                    .select('*')
                    .order('last_active', { ascending: false });

                if (usersError) throw usersError;

                // Fetch stats for each user
                const userStats = await Promise.all(
                    users.map(async (user) => {
                        try {
                            const stats = await callFunction('get_user_detailed_stats', user.id);
                            return { ...user, stats: stats[0] };
                        } catch (err) {
                            console.error(`Error loading stats for user ${user.id}:`, err);
                            return { ...user, stats: null };
                        }
                    })
                );

                allUsersData = userStats;

                // Render main dashboard
                renderOverallStats(userStats);
                renderUsersGrid(userStats);

                document.getElementById('loading').style.display = 'none';
                document.getElementById('mainDashboard').style.display = 'block';

            } catch (error) {
                console.error('Error loading dashboard:', error);
                showError('Failed to load dashboard: ' + error.message);
                document.getElementById('loading').style.display = 'none';
            }
        }

        function renderOverallStats(users) {
            const totalUsers = users.length;
            const activeToday = users.filter(u => {
                if (!u.last_active) return false;
                const lastActive = new Date(u.last_active);
                const today = new Date();
                return lastActive.toDateString() === today.toDateString();
            }).length;

            const totalWordsLearned = users.reduce((sum, u) => 
                sum + (u.stats?.total_words_learned || 0), 0
            );

            const avgSuccessRate = users.length > 0
                ? users.reduce((sum, u) => sum + (u.stats?.success_rate || 0), 0) / users.length
                : 0;

            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('activeToday').textContent = activeToday;
            document.getElementById('totalWords').textContent = totalWordsLearned;
            document.getElementById('avgSuccess').textContent = avgSuccessRate.toFixed(1) + '%';
        }

        function renderUsersGrid(users) {
            const grid = document.getElementById('usersGrid');
            
            if (users.length === 0) {
                grid.innerHTML = '<p style="color: white; text-align: center;">No users found</p>';
                return;
            }

            grid.innerHTML = users.map(user => {
                const stats = user.stats || {};
                const initial = user.name ? user.name.charAt(0).toUpperCase() : '?';
                const streak = stats.current_streak || 0;

                return `
                    <div class="user-card" onclick="showUserDetail('${user.id}')">
                        ${streak > 0 ? `<div class="streak-badge">üî• ${streak} days</div>` : ''}
                        
                        <div class="user-card-header">
                            <div class="user-avatar">${initial}</div>
                            <div class="user-info">
                                <h3>${user.name || 'Unknown User'}</h3>
                                <p>${user.phone_number || 'No phone'}</p>
                            </div>
                        </div>

                        <div class="user-stats">
                            <div class="user-stat-item">
                                <div class="user-stat-label">Words Learned</div>
                                <div class="user-stat-value">${stats.total_words_learned || 0}</div>
                            </div>
                            <div class="user-stat-item">
                                <div class="user-stat-label">Success Rate</div>
                                <div class="user-stat-value">${stats.success_rate || 0}%</div>
                            </div>
                            <div class="user-stat-item">
                                <div class="user-stat-label">Total Sessions</div>
                                <div class="user-stat-value">${stats.total_sessions || 0}</div>
                            </div>
                            <div class="user-stat-item">
                                <div class="user-stat-label">Days Active</div>
                                <div class="user-stat-value">${stats.days_active || 0}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ============================================
        // USER DETAIL VIEW
        // ============================================
        async function showUserDetail(userId) {
            // Hide main dashboard, show detail view
            document.getElementById('mainDashboard').style.display = 'none';
            document.getElementById('userDetailView').style.display = 'block';
            document.getElementById('loading').style.display = 'block';

            try {
                // Fetch detailed data
                const [
                    stats,
                    challengingWords,
                    progressTimeline,
                    recentActivity,
                    wordMastery,
                    mistakesByType
                ] = await Promise.all([
                    callFunction('get_user_detailed_stats', userId),
                    callFunction('get_user_challenging_words', userId, 10),
                    callFunction('get_user_progress_timeline', userId, 30),
                    callFunction('get_user_recent_activity', userId, 10),
                    callFunction('get_user_word_mastery', userId),
                    callFunction('get_user_mistakes_by_type', userId)
                ]);

                // Render detail view
                const userStats = stats[0];
                document.getElementById('userDetailName').textContent = userStats.name || 'User Details';
                document.getElementById('userDetailInfo').textContent = 
                    `${userStats.phone_number || 'No phone'} ‚Ä¢ Member since ${formatDate(userStats.member_since)}`;

                renderDetailStats(userStats);
                renderDetailChallengingWords(challengingWords);
                renderDetailWordMastery(wordMastery);
                renderDetailMistakeChart(mistakesByType);
                renderDetailTimeline(progressTimeline);
                renderDetailActivity(recentActivity);

                document.getElementById('loading').style.display = 'none';

            } catch (error) {
                console.error('Error loading user details:', error);
                showError('Failed to load user details: ' + error.message);
                document.getElementById('loading').style.display = 'none';
            }
        }

        function showMainDashboard() {
            document.getElementById('userDetailView').style.display = 'none';
            document.getElementById('mainDashboard').style.display = 'block';
        }

        function renderDetailStats(stats) {
            document.getElementById('detailStreak').textContent = stats.current_streak;
            document.getElementById('detailStreakProgress').style.width = 
                Math.min((stats.current_streak / stats.longest_streak) * 100, 100) + '%';

            document.getElementById('detailSuccess').textContent = stats.success_rate + '%';
            document.getElementById('detailSuccessProgress').style.width = stats.success_rate + '%';

            document.getElementById('detailLearningStats').innerHTML = `
                <div class="stat-item">
                    <div class="stat-label">Today</div>
                    <div class="stat-value">${stats.words_today}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">This Week</div>
                    <div class="stat-value">${stats.words_this_week}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">This Month</div>
                    <div class="stat-value">${stats.words_this_month}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Total</div>
                    <div class="stat-value">${stats.total_words_learned}</div>
                </div>
            `;
        }

        function renderDetailWordMastery(mastery) {
            if (!mastery || mastery.length === 0) {
                document.getElementById('detailWordMastery').innerHTML = '<p style="color: #666;">No data</p>';
                return;
            }

            const html = mastery.map(m => `
                <div class="list-item">
                    <div>
                        <strong>${m.difficulty}</strong>
                        <span class="badge ${m.difficulty.toLowerCase()}">${m.total_words} words</span>
                    </div>
                    <span>${m.mastery_percentage}%</span>
                </div>
            `).join('');
            
            document.getElementById('detailWordMastery').innerHTML = html;
        }

        function renderDetailChallengingWords(words) {
            if (!words || words.length === 0) {
                document.getElementById('detailChallengingWords').innerHTML = '<p style="color: #666;">No challenging words</p>';
                return;
            }

            const html = words.map(w => `
                <div class="list-item">
                    <div>
                        <strong>${w.word}</strong> - ${w.translation}
                        <span class="badge ${w.difficulty_level.toLowerCase()}">${w.difficulty_level}</span>
                    </div>
                    <span>${w.mistake_count} mistakes</span>
                </div>
            `).join('');
            
            document.getElementById('detailChallengingWords').innerHTML = html;
        }

        function renderDetailMistakeChart(mistakes) {
            if (!mistakes || mistakes.length === 0) return;

            const ctx = document.getElementById('detailMistakeChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: mistakes.map(m => m.mistake_type),
                    datasets: [{
                        data: mistakes.map(m => m.count),
                        backgroundColor: ['#667eea', '#764ba2', '#f093fb', '#4facfe', '#43e97b']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        function renderDetailTimeline(timeline) {
            if (!timeline || timeline.length === 0) return;

            const ctx = document.getElementById('detailTimelineChart').getContext('2d');
            const sorted = timeline.sort((a, b) => new Date(a.date) - new Date(b.date));

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sorted.map(t => formatDate(t.date)),
                    datasets: [{
                        label: 'Words Learned',
                        data: sorted.map(t => t.words_learned),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'top' } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        function renderDetailActivity(activity) {
            if (!activity || activity.length === 0) {
                document.getElementById('detailRecentActivity').innerHTML = 
                    '<tr><td colspan="3" style="text-align:center; color:#666;">No recent activity</td></tr>';
                return;
            }

            const html = `
                <thead>
                    <tr><th>Date</th><th>Word</th><th>Status</th></tr>
                </thead>
                <tbody>
                    ${activity.map(a => `
                        <tr>
                            <td>${formatDate(a.created_at)}</td>
                            <td><strong>${a.word}</strong> - ${a.translation}</td>
                            <td>
                                ${a.was_correct ? '<span class="badge easy">‚úì</span>' : ''}
                                ${a.had_mistake ? '<span class="badge hard">‚úó</span>' : ''}
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
            document.getElementById('detailRecentActivity').innerHTML = html;
        }

        // ============================================
        // HELPER FUNCTIONS
        // ============================================
        async function callFunction(functionName, userId, param2) {
            const params = param2 !== undefined 
                ? { p_user_id: userId, p_limit: param2, p_days: param2 }
                : { p_user_id: userId };

            const { data, error } = await supabase.rpc(functionName, params);
            if (error) throw error;
            return data || [];
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }

        function showError(message) {
            const errorEl = document.getElementById('error');
            errorEl.textContent = message;
            errorEl.classList.add('active');
            setTimeout(() => errorEl.classList.remove('active'), 5000);
        }
    </script>
</body>
</html>
