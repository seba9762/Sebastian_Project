<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Learning Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
        }

        .user-selector {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .user-selector input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .user-selector button {
            padding: 12px 30px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .user-selector button:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card .icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .stat-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
        }

        .stat-label {
            color: #666;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .stat-value {
            color: #333;
            font-size: 24px;
            font-weight: 700;
        }

        .stat-value.large {
            font-size: 36px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s ease;
        }

        .list-item {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .list-item strong {
            color: #333;
        }

        .list-item span {
            color: #666;
            font-size: 14px;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge.critical {
            background: #ffe0e0;
            color: #d32f2f;
        }

        .badge.major {
            background: #fff3e0;
            color: #f57c00;
        }

        .badge.minor {
            background: #e8f5e9;
            color: #388e3c;
        }

        .badge.easy {
            background: #e8f5e9;
            color: #388e3c;
        }

        .badge.moderate {
            background: #fff3e0;
            color: #f57c00;
        }

        .badge.hard {
            background: #ffe0e0;
            color: #d32f2f;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            display: none;
        }

        .loading.active {
            display: block;
        }

        .error {
            background: #ffe0e0;
            color: #d32f2f;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .error.active {
            display: block;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        .wide-card {
            grid-column: 1 / -1;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-size: 12px;
            text-transform: uppercase;
            color: #666;
            border-bottom: 2px solid #e0e0e0;
        }

        .table td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
            color: #333;
        }

        .table tr:hover {
            background: #f8f9fa;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            .stat-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üìö User Learning Dashboard</h1>
            <p>Comprehensive analytics powered by 12 database functions</p>
            
            <!-- User ID Input -->
            <div class="user-selector">
                <input type="text" id="userIdInput" placeholder="Enter User ID (UUID)" value="">
                <button onclick="loadUserData()">Load Dashboard</button>
            </div>
        </div>

        <!-- Loading State -->
        <div class="loading" id="loading">
            <h3>‚è≥ Loading user data...</h3>
        </div>

        <!-- Error State -->
        <div class="error" id="error"></div>

        <!-- Dashboard Content -->
        <div id="dashboard" style="display: none;">
            
            <!-- User Stats Overview -->
            <div class="grid">
                <div class="card">
                    <h3><div class="icon">üë§</div> User Overview</h3>
                    <div id="userOverview"></div>
                </div>

                <div class="card">
                    <h3><div class="icon">üî•</div> Current Streak</h3>
                    <div class="stat-value large" id="currentStreak">0</div>
                    <div class="stat-label">Days in a row</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="streakProgress" style="width: 0%"></div>
                    </div>
                </div>

                <div class="card">
                    <h3><div class="icon">üìà</div> Progress</h3>
                    <div id="progressStats"></div>
                </div>

                <div class="card">
                    <h3><div class="icon">üéØ</div> Success Rate</h3>
                    <div class="stat-value large" id="successRate">0%</div>
                    <div class="stat-label">Overall accuracy</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="successProgress" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Detailed Stats -->
            <div class="grid">
                <div class="card">
                    <h3><div class="icon">üìä</div> Learning Stats</h3>
                    <div class="stat-grid" id="learningStats"></div>
                </div>

                <div class="card">
                    <h3><div class="icon">‚è∞</div> Study Patterns</h3>
                    <div id="studyPatterns"></div>
                </div>

                <div class="card">
                    <h3><div class="icon">üí™</div> Word Mastery</h3>
                    <div id="wordMastery"></div>
                </div>

                <div class="card">
                    <h3><div class="icon">‚ùå</div> Mistake Summary</h3>
                    <div id="mistakeSummary"></div>
                </div>
            </div>

            <!-- Challenging Words -->
            <div class="card wide-card">
                <h3><div class="icon">üò∞</div> Most Challenging Words</h3>
                <div id="challengingWords"></div>
            </div>

            <!-- Mistake Analytics -->
            <div class="grid">
                <div class="card">
                    <h3><div class="icon">üìã</div> Mistakes by Type</h3>
                    <div class="chart-container">
                        <canvas id="mistakeTypeChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h3><div class="icon">üè∑Ô∏è</div> Mistakes by Category</h3>
                    <div class="chart-container">
                        <canvas id="mistakeCategoryChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="card wide-card">
                <h3><div class="icon">üìÖ</div> Recent Activity</h3>
                <table class="table" id="recentActivity"></table>
            </div>

            <!-- Progress Timeline -->
            <div class="card wide-card">
                <h3><div class="icon">üìà</div> Progress Timeline (Last 30 Days)</h3>
                <div class="chart-container" style="height: 400px;">
                    <canvas id="timelineChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // SUPABASE CONFIGURATION
        // ============================================
        const SUPABASE_URL = 'YOUR_SUPABASE_URL';
        const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ============================================
        // MAIN FUNCTION TO LOAD USER DATA
        // ============================================
        async function loadUserData() {
            const userId = document.getElementById('userIdInput').value.trim();
            
            if (!userId) {
                showError('Please enter a User ID');
                return;
            }

            // Show loading state
            document.getElementById('loading').classList.add('active');
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('error').classList.remove('active');

            try {
                // Fetch all data in parallel
                const [
                    detailedStats,
                    challengingWords,
                    progressTimeline,
                    recentActivity,
                    wordMastery,
                    learningPatterns,
                    progressDetailed,
                    mistakesByType,
                    mistakesByCategory,
                    mistakesBySeverity,
                    mistakeAnalysis,
                    mistakeTrends
                ] = await Promise.all([
                    callFunction('get_user_detailed_stats', userId),
                    callFunction('get_user_challenging_words', userId, 10),
                    callFunction('get_user_progress_timeline', userId, 30),
                    callFunction('get_user_recent_activity', userId, 10),
                    callFunction('get_user_word_mastery', userId),
                    callFunction('get_user_learning_patterns', userId),
                    callFunction('get_user_progress_detailed', userId),
                    callFunction('get_user_mistakes_by_type', userId),
                    callFunction('get_user_mistakes_by_category', userId),
                    callFunction('get_user_mistakes_by_severity', userId),
                    callFunction('get_user_mistake_analysis', userId),
                    callFunction('get_user_mistake_trends', userId, 30)
                ]);

                // Render all sections
                renderUserOverview(detailedStats[0]);
                renderCurrentStreak(detailedStats[0]);
                renderProgressStats(detailedStats[0], progressDetailed[0]);
                renderSuccessRate(detailedStats[0]);
                renderLearningStats(detailedStats[0]);
                renderStudyPatterns(learningPatterns, progressDetailed[0]);
                renderWordMastery(wordMastery);
                renderMistakeSummary(mistakeAnalysis[0]);
                renderChallengingWords(challengingWords);
                renderMistakeCharts(mistakesByType, mistakesByCategory);
                renderRecentActivity(recentActivity);
                renderProgressTimeline(progressTimeline);

                // Show dashboard
                document.getElementById('loading').classList.remove('active');
                document.getElementById('dashboard').style.display = 'block';

            } catch (error) {
                console.error('Error loading user data:', error);
                showError('Failed to load user data: ' + error.message);
                document.getElementById('loading').classList.remove('active');
            }
        }

        // ============================================
        // HELPER: CALL SUPABASE FUNCTION
        // ============================================
        async function callFunction(functionName, userId, param2) {
            const params = param2 !== undefined 
                ? { p_user_id: userId, p_limit: param2, p_days: param2 }
                : { p_user_id: userId };

            const { data, error } = await supabase.rpc(functionName, params);
            
            if (error) throw error;
            return data || [];
        }

        // ============================================
        // RENDER FUNCTIONS
        // ============================================
        
        function renderUserOverview(stats) {
            const html = `
                <div class="stat-item">
                    <div class="stat-label">Name</div>
                    <div class="stat-value" style="font-size: 18px;">${stats.name || 'Unknown'}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Member Since</div>
                    <div class="stat-value" style="font-size: 14px;">${formatDate(stats.member_since)}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Last Active</div>
                    <div class="stat-value" style="font-size: 14px;">${formatDate(stats.last_active)}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Phone</div>
                    <div class="stat-value" style="font-size: 14px;">${stats.phone_number || 'N/A'}</div>
                </div>
            `;
            document.getElementById('userOverview').innerHTML = html;
        }

        function renderCurrentStreak(stats) {
            document.getElementById('currentStreak').textContent = stats.current_streak;
            const percentage = Math.min((stats.current_streak / stats.longest_streak) * 100, 100) || 0;
            document.getElementById('streakProgress').style.width = percentage + '%';
        }

        function renderProgressStats(stats, detailed) {
            const html = `
                <div class="stat-item">
                    <div class="stat-label">Words Learned</div>
                    <div class="stat-value">${stats.total_words_learned}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Days Active</div>
                    <div class="stat-value">${stats.days_active}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Total Sessions</div>
                    <div class="stat-value">${stats.total_sessions}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Completion</div>
                    <div class="stat-value">${detailed?.learning_percentage || 0}%</div>
                </div>
            `;
            document.getElementById('progressStats').innerHTML = html;
        }

        function renderSuccessRate(stats) {
            document.getElementById('successRate').textContent = stats.success_rate + '%';
            document.getElementById('successProgress').style.width = stats.success_rate + '%';
        }

        function renderLearningStats(stats) {
            const html = `
                <div class="stat-item">
                    <div class="stat-label">Today</div>
                    <div class="stat-value">${stats.words_today}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">This Week</div>
                    <div class="stat-value">${stats.words_this_week}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">This Month</div>
                    <div class="stat-value">${stats.words_this_month}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Avg/Session</div>
                    <div class="stat-value">${stats.average_session_words}</div>
                </div>
            `;
            document.getElementById('learningStats').innerHTML = html;
        }

        function renderStudyPatterns(patterns, detailed) {
            if (!patterns || patterns.length === 0) {
                document.getElementById('studyPatterns').innerHTML = '<p style="color: #666;">No pattern data available</p>';
                return;
            }

            const bestHour = detailed?.best_study_hour;
            const topPattern = patterns.find(p => p.hour_of_day === bestHour) || patterns[0];

            const html = `
                <div class="stat-item">
                    <div class="stat-label">Best Study Hour</div>
                    <div class="stat-value">${formatHour(topPattern.hour_of_day)}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Sessions</div>
                    <div class="stat-value">${topPattern.session_count}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Words Studied</div>
                    <div class="stat-value">${topPattern.total_words}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Success Rate</div>
                    <div class="stat-value">${topPattern.avg_success_rate}%</div>
                </div>
            `;
            document.getElementById('studyPatterns').innerHTML = html;
        }

        function renderWordMastery(mastery) {
            if (!mastery || mastery.length === 0) {
                document.getElementById('wordMastery').innerHTML = '<p style="color: #666;">No mastery data available</p>';
                return;
            }

            const html = mastery.map(m => `
                <div class="list-item">
                    <div>
                        <strong>${m.difficulty}</strong>
                        <span class="badge ${m.difficulty.toLowerCase()}">${m.total_words} words</span>
                    </div>
                    <div>
                        <span>${m.mastery_percentage}% mastery</span>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('wordMastery').innerHTML = html;
        }

        function renderMistakeSummary(analysis) {
            if (!analysis) {
                document.getElementById('mistakeSummary').innerHTML = '<p style="color: #666;">No mistake data available</p>';
                return;
            }

            const html = `
                <div class="stat-item">
                    <div class="stat-label">Total Mistakes</div>
                    <div class="stat-value">${analysis.total_mistakes || 0}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Most Common Type</div>
                    <div class="stat-value" style="font-size: 14px;">${analysis.most_common_type || 'N/A'}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Category</div>
                    <div class="stat-value" style="font-size: 14px;">${analysis.most_common_category || 'N/A'}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Recent (7 days)</div>
                    <div class="stat-value">${analysis.recent_mistakes || 0}</div>
                </div>
            `;
            document.getElementById('mistakeSummary').innerHTML = html;
        }

        function renderChallengingWords(words) {
            if (!words || words.length === 0) {
                document.getElementById('challengingWords').innerHTML = '<p style="color: #666;">No challenging words yet!</p>';
                return;
            }

            const html = words.map(w => `
                <div class="list-item">
                    <div>
                        <strong>${w.word}</strong> - ${w.translation}
                        <span class="badge ${w.difficulty_level.toLowerCase()}">${w.difficulty_level}</span>
                    </div>
                    <div>
                        <span>${w.mistake_count} mistakes</span>
                        <span style="margin-left: 10px; color: #999;">${formatDate(w.last_mistake)}</span>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('challengingWords').innerHTML = html;
        }

        function renderMistakeCharts(byType, byCategory) {
            // Mistake Type Chart
            if (byType && byType.length > 0) {
                const ctx1 = document.getElementById('mistakeTypeChart').getContext('2d');
                new Chart(ctx1, {
                    type: 'doughnut',
                    data: {
                        labels: byType.map(m => m.mistake_type),
                        datasets: [{
                            data: byType.map(m => m.count),
                            backgroundColor: [
                                '#667eea', '#764ba2', '#f093fb', '#4facfe',
                                '#43e97b', '#fa709a', '#fee140', '#30cfd0'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            // Mistake Category Chart
            if (byCategory && byCategory.length > 0) {
                const ctx2 = document.getElementById('mistakeCategoryChart').getContext('2d');
                new Chart(ctx2, {
                    type: 'doughnut',
                    data: {
                        labels: byCategory.map(m => m.mistake_category),
                        datasets: [{
                            data: byCategory.map(m => m.count),
                            backgroundColor: [
                                '#667eea', '#764ba2', '#f093fb', '#4facfe',
                                '#43e97b', '#fa709a', '#fee140', '#30cfd0'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
        }

        function renderRecentActivity(activity) {
            if (!activity || activity.length === 0) {
                document.getElementById('recentActivity').innerHTML = '<tr><td colspan="4" style="text-align: center; color: #666;">No recent activity</td></tr>';
                return;
            }

            const html = `
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Word</th>
                        <th>Translation</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    ${activity.map(a => `
                        <tr>
                            <td>${formatDate(a.created_at)}</td>
                            <td><strong>${a.word}</strong></td>
                            <td>${a.translation}</td>
                            <td>
                                ${a.was_correct ? '<span class="badge easy">Correct</span>' : ''}
                                ${a.had_mistake ? '<span class="badge hard">Mistake</span>' : ''}
                                ${!a.had_response ? '<span class="badge moderate">Pending</span>' : ''}
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
            document.getElementById('recentActivity').innerHTML = html;
        }

        function renderProgressTimeline(timeline) {
            if (!timeline || timeline.length === 0) {
                return;
            }

            const ctx = document.getElementById('timelineChart').getContext('2d');
            const sortedData = timeline.sort((a, b) => new Date(a.date) - new Date(b.date));

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedData.map(t => formatDate(t.date)),
                    datasets: [
                        {
                            label: 'Words Learned',
                            data: sortedData.map(t => t.words_learned),
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Mistakes',
                            data: sortedData.map(t => t.mistakes_made),
                            borderColor: '#d32f2f',
                            backgroundColor: 'rgba(211, 47, 47, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }

        function formatHour(hour) {
            if (hour === null || hour === undefined) return 'N/A';
            const suffix = hour >= 12 ? 'PM' : 'AM';
            const displayHour = hour % 12 || 12;
            return `${displayHour}:00 ${suffix}`;
        }

        function showError(message) {
            const errorEl = document.getElementById('error');
            errorEl.textContent = message;
            errorEl.classList.add('active');
            setTimeout(() => {
                errorEl.classList.remove('active');
            }, 5000);
        }

        // ============================================
        // INITIALIZE
        // ============================================
        
        // Load test user on page load (optional)
        window.addEventListener('DOMContentLoaded', () => {
            // Uncomment to auto-load a test user
            // document.getElementById('userIdInput').value = 'YOUR-TEST-USER-ID';
            // loadUserData();
        });
    </script>
</body>
</html>
